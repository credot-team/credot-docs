---
title: 實體機db備份
sidebar_position: 1
---

## sh

```sh
#使用者名稱
username=root
#密碼
password=nicai
#將要備份的資料庫
database_name=l_love_you

#儲存備份檔案最多個數
count=30
#備份儲存路徑
backup_path=/app/mysql_backup
#日期
date_time=`date +%Y-%m-%d-%H-%M`

#如果資料夾不存在則建立
if [ ! -d $backup_path ];
then
 mkdir -p $backup_path;
fi

#開始備份
mysqldump -u $username -p$password $database_name > $backup_path/$database_name-$date_time.sql
# postgres 
# pg_dump -h [ip] -U [使用者名稱] [庫名] >[匯出的.sql 檔案]

#開始壓縮
cd $backup_path
tar -zcvf $database_name-$date_time.tar.gz $database_name-$date_time.sql

#刪除原始檔
rm -rf $backup_path/$database_name-$date_time.sql

#更新備份日誌
echo "create $backup_path/$database_name-$date_time.tar.gz" >> $backup_path/dump.log

#找出需要刪除的備份
delfile=`ls -l -crt $backup_path/*.tar.gz | awk '{print $9 }' | head -1`

#判斷現在的備份數量是否大於閾值
number=`ls -l -crt $backup_path/*.tar.gz | awk '{print $9 }' | wc -l`

if [ $number -gt $count ]
then
 #刪除最早生成的備份，只保留count數量的備份
 rm $delfile
 #更新刪除檔案日誌
 echo "delete $delfile" >> $backup_path/dump.log
fi

```

>  00 01 * * * /app/dump_mysql.sh


## 恢復

### postgres

> psql -s [庫名] -f [匯出.sql 檔案]

### mysql

> mysql -u [使用者名稱] -p [庫名] < [匯出的.sql 檔案]

## 參考連結

- [利用Linux crontab](https://www.gushiciku.cn/pl/pNKU/zh-tw)
- [Linux下MySQL備份以及crontab定時備份](https://www.itread01.com/content/1548532998.html)