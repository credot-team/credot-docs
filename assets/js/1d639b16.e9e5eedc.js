(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{148:function(e,n,t){"use strict";t.d(n,"a",(function(){return d})),t.d(n,"b",(function(){return m}));var r=t(0),a=t.n(r);function c(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){c(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},c=Object.keys(e);for(r=0;r<c.length;r++)t=c[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(r=0;r<c.length;r++)t=c[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var i=a.a.createContext({}),b=function(e){var n=a.a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},d=function(e){var n=b(e.components);return a.a.createElement(i.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.a.createElement(a.a.Fragment,{},n)}},p=a.a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,c=e.originalType,o=e.parentName,i=s(e,["components","mdxType","originalType","parentName"]),d=b(t),p=r,m=d["".concat(o,".").concat(p)]||d[p]||u[p]||c;return t?a.a.createElement(m,l(l({ref:n},i),{},{components:t})):a.a.createElement(m,l({ref:n},i))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var c=t.length,o=new Array(c);o[0]=p;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var i=2;i<c;i++)o[i]=t[i];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,t)}p.displayName="MDXCreateElement"},84:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return o})),t.d(n,"metadata",(function(){return l})),t.d(n,"toc",(function(){return s})),t.d(n,"default",(function(){return b}));var r=t(3),a=t(7),c=(t(0),t(148)),o={title:"setting",sidebar_position:1},l={unversionedId:"advanced/CICD/setting",id:"advanced/CICD/setting",isDocsHomePage:!1,title:"setting",description:"domain",source:"@site/docs/advanced/CICD/setting.md",sourceDirName:"advanced/CICD",slug:"/advanced/CICD/setting",permalink:"/credot-docs/docs/advanced/CICD/setting",editUrl:"https://github.com/skynocover/credot-docs/tree/documentation/docs/advanced/CICD/setting.md",version:"current",sidebarPosition:1,frontMatter:{title:"setting",sidebar_position:1},sidebar:"docsSidebar",previous:{title:"node",permalink:"/credot-docs/docs/install/node"},next:{title:"example",permalink:"/credot-docs/docs/advanced/CICD/example"}},s=[{value:"domain",id:"domain",children:[{value:"caddy",id:"caddy",children:[]}]},{value:"github",id:"github",children:[{value:"\u5efa\u7acb\u65b0\u7684 OAuth",id:"\u5efa\u7acb\u65b0\u7684-oauth",children:[]}]},{value:"drone",id:"drone",children:[]},{value:"install",id:"install",children:[]},{value:"\u4f48\u7f72",id:"\u4f48\u7f72",children:[{value:"active",id:"active",children:[]},{value:"yaml",id:"yaml",children:[]},{value:"dockerfile",id:"dockerfile",children:[]},{value:"\u5c0dcommit\u4e0btag",id:"\u5c0dcommit\u4e0btag",children:[]}]},{value:"ubuntu service\u90e8\u7f72",id:"ubuntu-service\u90e8\u7f72",children:[{value:"script",id:"script",children:[]},{value:"drone\u8a2d\u5b9a",id:"drone\u8a2d\u5b9a",children:[]}]},{value:"slack",id:"slack",children:[{value:"\u5efa\u7acbwebhook",id:"\u5efa\u7acbwebhook",children:[]},{value:"yaml",id:"yaml-1",children:[]}]},{value:"secret",id:"secret",children:[]},{value:"P.S.",id:"ps",children:[{value:"\u53c3\u8003\u9023\u7d50",id:"\u53c3\u8003\u9023\u7d50",children:[]}]}],i={toc:s};function b(e){var n=e.components,t=Object(a.a)(e,["components"]);return Object(c.b)("wrapper",Object(r.a)({},i,t,{components:n,mdxType:"MDXLayout"}),Object(c.b)("h2",{id:"domain"},"domain"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"ngrok"),Object(c.b)("li",{parentName:"ul"},"caddy")),Object(c.b)("h3",{id:"caddy"},"caddy"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-caddy"},"credotcicd.ml:80 {\n    reverse_proxy http://localhost:8080 {\n         header_up Host {http.reverse_proxy.upstream.hostport}\n         header_up X-Real-IP {http.request.remote}\n         header_up X-Forwarded-For {http.request.remote}\n         header_up X-Forwarded-Port {http.request.port}\n         header_up X-Forwarded-Proto {http.request.scheme}\n    }\n}\n")),Object(c.b)("h2",{id:"github"},"github"),Object(c.b)("h3",{id:"\u5efa\u7acb\u65b0\u7684-oauth"},"\u5efa\u7acb\u65b0\u7684 OAuth"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",{parentName:"li",href:"https://github.com/settings/applications/new"},"\u524d\u5f80\u4e26\u5efa\u7acb")),Object(c.b)("li",{parentName:"ul"},"Homepage URL ",Object(c.b)("a",{parentName:"li",href:"http://524c5b23a4f8.ngrok.io"},"http://524c5b23a4f8.ngrok.io")," (ngrok\u7522\u751f\u7684)"),Object(c.b)("li",{parentName:"ul"},"Authorization callback URL ",Object(c.b)("a",{parentName:"li",href:"http://524c5b23a4f8.ngrok.io/login"},"http://524c5b23a4f8.ngrok.io/login")," (ngrok\u7522\u751f\u7684)"),Object(c.b)("li",{parentName:"ul"},"\u7522\u751f Client secrets \u4e26\u8a18\u9304"),Object(c.b)("li",{parentName:"ul"},"\u7d00\u9304 Client ID")),Object(c.b)("h2",{id:"drone"},"drone"),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},Object(c.b)("a",{parentName:"p",href:"https://www.drone.io"},"https://www.drone.io"))),Object(c.b)("h2",{id:"install"},"install"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"docker-compose.yml")),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-yaml"},'version: "3"\n\nservices:\n  drone-server:\n    image: drone/drone:latest #\u6307\u5b9aserver\u70badrone\u6700\u65b0\u7248\n    ports:\n      - 8080:80\n    volumes:\n      - ./:/data\n    restart: always\n    environment:\n      - DRONE_SERVER_HOST=${DRONE_SERVER_HOST} #Drone server url \u586b\u5beb\u5728.env\u6a94\u6848\u4e2d\n      - DRONE_SERVER_PROTO=${DRONE_SERVER_PROTO} #Drone server protocol \u586b\u5beb\u5728.env\u6a94\u6848\u4e2d\n      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET} #\u81ea\u5b9a\u7fa9\u96a8\u6a5f\u78bc\uff0c\u586b\u5beb\u5728.env\u6a94\u6848\u4e2d\n      - DRONE_AGENTS_ENABLED=true\n      # Github Config\n      - DRONE_GITHUB_CLIENT_ID=${DRONE_GITHUB_CLIENT_ID} #github client ID\uff0c\u586b\u5beb\u5728.env\u6a94\u6848\u4e2d\n      - DRONE_GITHUB_CLIENT_SECRET=${DRONE_GITHUB_CLIENT_SECRET} #github client secret\uff0c\u586b\u5beb\u5728.env\u6a94\u6848\u4e2d\n  drone-agent:\n    image: drone/drone-runner-docker:latest\n    ports:\n      - 3000:3000\n    restart: always\n    depends_on:\n      - drone-server\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock\n    environment:\n      - DRONE_RPC_PROTO=http\n      - DRONE_RPC_HOST=drone-server\n      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET}\n      - DRONE_RUNNER_NAME=${DRONE_HOSTNAME} #\u81ea\u8a02host name \u586b\u5beb\u5728.env\u6a94\u6848\u4e2d\n      - DRONE_RUNNER_CAPACITY=2\n')),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"env")),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},"DRONE_SERVER_HOST=524c5b23a4f8.ngrok.io\nDRONE_SERVER_PROTO=http\nDRONE_RPC_SECRET=gEY6Ys1knt3fJnAsda\nDRONE_GITHUB_CLIENT_ID=4292f3927a2166d960c9\nDRONE_GITHUB_CLIENT_SECRET=97106a15a3929c8b79d5cce7cae4261f535d4c69\nDRONE_HOSTNAME=test_host\n")),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"DRONE_SERVER_HOST ngrok \u7d66\u7684 host \u6216 ip port (\u4e0d\u9700\u8981 http://)"),Object(c.b)("li",{parentName:"ul"},"DRONE_RPC_SECRET \u81ea\u5b9a\u7fa9\u4e82\u6578"),Object(c.b)("li",{parentName:"ul"},"DRONE_GITHUB_CLIENT_ID"),Object(c.b)("li",{parentName:"ul"},"DRONE_GITHUB_CLIENT_SECRET"),Object(c.b)("li",{parentName:"ul"},"DRONE_HOSTNAME")),Object(c.b)("h2",{id:"\u4f48\u7f72"},"\u4f48\u7f72"),Object(c.b)("h3",{id:"active"},"active"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"\u91dd\u5c0d\u6bcf\u4e00\u500b repo \u524d\u5f80\u525b\u525b\u7522\u751f\u7684ngrok\u7db2\u5740\u9032\u884c active \u4e26 SAVE"),Object(c.b)("li",{parentName:"ul"},"\u8a2d\u5b9asecret (hubname,hubsecret) \u8b93dockerhub\u5e33\u865f\u8ddf\u5bc6\u78bc\u4e0d\u6703\u5728yaml\u6a94\u4e2d\u986f\u793a")),Object(c.b)("h3",{id:"yaml"},"yaml"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("p",{parentName:"li"},"\u65bc\u6bcf\u500b\u5c08\u6848\u5167\u52a0\u5165.drone.yml\u6a94")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("p",{parentName:"li"},".drone.yml"))),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-yaml"},"kind: pipeline\ntype: docker #\u5728docker\u74b0\u5883\u4e2d\u57f7\u884c\nname: test #\u81ea\u5b9a\u7fa9pipleline\u540d\u7a31\n\nsteps: #\u5de5\u4f5c\u5217\u8868\n  # - name: tsc\n  #   when:\n  #     event: tag\n  #   pull: if-not-exists #\u8981\u4e0d\u8981pull\u6307\u5b9a\u7684image\n  #   image: node:current-alpine3.12\n  #   commands: # \u9700\u57f7\u884c\u7684\u6307\u4ee4\n  #     - yarn global add typescript\n  #     - yarn install\n  #     - yarn bundle\n\n  - name: build-image #\u81ea\u8a02\u5de5\u4f5c\u540d\u7a31\n    when:\n      event: tag\n    pull: if-not-exists #\u8981\u4e0d\u8981pull\u6307\u5b9a\u7684image\n    image: plugins/docker #\u6307\u5b9a\u8981\u62ff\u4f86\u57f7\u884ccommand\u7684image\u6216\u8005plugin\n    settings:\n      registry: registry.hub.docker.com #dockerhub registry url\n      repo: registry.hub.docker.com/skynocover/amber-server #\u6253\u5305\u5b8c\u8981\u4e0a\u50b3\u7684docker repo\u540d\u7a31\n      dockerfile: dockerfile #\u6839\u64da\u6307\u5b9a\u7684Docker file\u6253\u5305image\n      #auto_tag: true #\u81ea\u52d5\u4e0btag\n      username:\n        from_secret: hubname\n      password:\n        from_secret: hubsecret\n      tags:\n        - latest\n        - ${DRONE_TAG}\n\n  - name: ssh-deploy ## \u4f7f\u7528ssh\u9060\u7aef\u57f7\u884c\u90e8\u7f72\n    when:\n      event: tag\n    image: appleboy/drone-ssh\n    settings:\n      host:\n        from_secret: sshhost\n      username:\n        from_secret: sshname\n      password:\n        from_secret: sshkey\n      port: 22\n      command_timeout: 2m\n      script:\n        - cd /root/temp # or whereever you put your `deploy.sh`\n        - sh deploy.sh\n")),Object(c.b)("h3",{id:"dockerfile"},"dockerfile"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-dockerfile"},'FROM node:current-alpine3.12\nRUN mkdir /src\nCOPY .env /src\nCOPY cfg /src/cfg\nCOPY src /src/src\nCOPY webpack.config.js /src\nCOPY tsconfig.json /src\nCOPY package.json /src\nCOPY public /src/public\nWORKDIR /src\nRUN yarn install\nRUN yarn global add typescript\nRUN yarn global add webpack\nRUN yarn global add webpack-cli\nRUN tsc && webpack\nCMD ["node","dist/index.min.js"]\n')),Object(c.b)("h3",{id:"\u5c0dcommit\u4e0btag"},"\u5c0dcommit\u4e0btag"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"\u683c\u5f0f vX.X.X")),Object(c.b)("h2",{id:"ubuntu-service\u90e8\u7f72"},"ubuntu service\u90e8\u7f72"),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"\u81ea\u52d5\u90e8\u7f72")),Object(c.b)("h3",{id:"script"},"script"),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"vim deploy.sh")),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-sh"},'#!/bin/bash\necho "Updating staging Server"\necho "stopping amber.service"\n#sudo systemctl stop amber.service\ndocker stop amber\ndocker rm amber\n# remove all outdated images and containers\necho "removing outdated/dangling images and containers"\nsudo docker rmi skynocover/amber-server:latest\n# create new image for projectName\necho "create new image for amber"\nsudo docker pull skynocover/amber-server:latest\n# restart service which will use the newly pulled image\necho "restarting amber service"\nsudo docker run --name=amber -p 3001:3001 -d skynocover/amber-server:latest\n# App is updated!\necho "amber successfuly updated!"\n')),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"sudo chmod +x deploy.sh")),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"sh deploy.sh")),Object(c.b)("h3",{id:"drone\u8a2d\u5b9a"},"drone\u8a2d\u5b9a"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-yaml"},"- name: ssh-deploy\n  when:\n    event: tag\n  image: appleboy/drone-ssh\n  settings:\n    host:\n      from_secret: sshhost\n    username:\n      from_secret: sshname\n    password:\n      from_secret: sshkey\n    port: 22\n    command_timeout: 2m\n    script:\n      - cd /root/temp # or whereever you put your `deploy.sh`\n      - sh deploy.sh\n")),Object(c.b)("h2",{id:"slack"},"slack"),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"\u4f7f\u7528slack\u767c\u9001channela")),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},Object(c.b)("a",{parentName:"p",href:"https://medium.com/@stu60610/%E4%BD%BF%E7%94%A8-docker-drone-%E5%BB%BA%E7%AB%8B%E7%B0%A1%E6%98%93%E8%87%AA%E5%8B%95%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B-part2-7d250e926bd8"},"link"))),Object(c.b)("h3",{id:"\u5efa\u7acbwebhook"},"\u5efa\u7acbwebhook"),Object(c.b)("p",null,Object(c.b)("a",{parentName:"p",href:"https://my.slack.com/services/new/incoming-webhook"},"slack websock")),Object(c.b)("h3",{id:"yaml-1"},"yaml"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre",className:"language-yaml"},"  - name: notify\n    when:\n      event: tag\n    image: plugins/slack\n    settings:\n      webhook: https://hooks.slack.com/services/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\n      channel: drone\n      username: drone\n      template: >\n        {{#success build.status}}\n          build {{build.number}} succeeded. Good job.\n        {{else}}\n          build {{build.number}} failed. Fix me please.\n        {{/success}}\n")),Object(c.b)("h2",{id:"secret"},"secret"),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"\u7d14\u8a18\u9304 \u975e\u5fc5\u8981")),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"drone secret -h")),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},"NAME:\n   drone secret - manage secrets\n\nUSAGE:\n   drone secret command [command options] [arguments...]\n\nCOMMANDS:\n     add     adds a secret\n     rm      remove a secret\n     update  update a secret\n     info    display secret info\n     ls      list secrets\n\nOPTIONS:\n   --help, -h  show help\n")),Object(c.b)("p",null,"\u65b0\u589e secret \u4e26\u7d81\u5b9a image \u53ca repository"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},"drone secret add \\\n  --name ssh-password \\\n  --data 1234567890 \\\n  --image appleboy/drone-ssh \\\n  --repository go-training/drone-workshop\n")),Object(c.b)("p",null,"\u65b0\u589e\u6a94\u6848"),Object(c.b)("p",null,"@\u5f8c\u9762\u70ba\u6a94\u6848\u8def\u5f91"),Object(c.b)("pre",null,Object(c.b)("code",{parentName:"pre"},"drone secret add \\\n  --name ssh-key \\\n  --data @/etc/server.pem \\\n  --image appleboy/drone-ssh \\\n  --repository go-training/drone-workshop\n")),Object(c.b)("h2",{id:"ps"},"P.S."),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"github \u76ee\u6a19 repo >settings >Webhooks")),Object(c.b)("p",null,"\u6aa2\u67e5 url \u662f\u5426\u6b63\u78ba"),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"\u82e5webhooks\u932f\u8aa4")),Object(c.b)("p",null,"\u5728drone\u4ecb\u9762\u5167\u91cd\u65b0enable"),Object(c.b)("h3",{id:"\u53c3\u8003\u9023\u7d50"},"\u53c3\u8003\u9023\u7d50"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",{parentName:"li",href:"https://medium.com/starbugs/%E5%BE%9E%E9%9B%B6%E9%96%8B%E5%A7%8B%E5%AD%B8-devops-%E9%82%A3%E5%B0%B1%E9%81%B8%E6%93%87%E6%9C%80%E7%B0%A1%E5%96%AE%E7%9A%84-drone-ci-%E9%96%8B%E5%A7%8B%E5%90%A7-931126671139"},"link")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",{parentName:"li",href:"https://blog.wu-boy.com/2019/04/cicd-drone-1-0-feature/"},"link"))))}b.isMDXComponent=!0}}]);